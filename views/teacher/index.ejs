<%- include('../partials/teacherHeader') %>

<div class="container-fluid">
    <div class="row">
        <%- include('../components/teacherSidebar') %>

        <div class="content col-md-10 mt-3">
            <section class=" bg-light">
                <div class="row">
                  <div class="col-12 pb-3">
                    <h1 class="h4">Generate Attendance QR Code</h1>
                    <nav aria-label="breadcrumb">
                      <ol class="breadcrumb m-0 fs-7">
                        <li class="breadcrumb-item"><a class="link-primary text-decoration-none" href="/teacher">Home</a></li>
                      </ol>
                    </nav>
                  </div>
                </div>
            </section>
        
            <!-- QR Code Generation Section -->
            <div class="card mt-4">
                <div class="card-body">
                    <form id="generate-qr-form">
                        <div class="mb-3">
                            <label for="course-code" class="form-label">Subject Code</label>
                            <input type="text" class="form-control" id="course-code" name="course-code"
                                placeholder="Enter subject code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate QR Code</button>
                    </form>
        
                    <!-- QR Modal -->
                    <div id="qr-modal" class="modal fade" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="qrModalLabel">QR Code for Attendance</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <img id="qr-code-image" src="" alt="QR Code" class="img-fluid mb-3">
                                    <p id="expiry-message" class="text-danger mt-2"></p>
                                    <p id="countdown-timer" class="text-info"></p>
                                    <a id="download-link" class="btn btn-success" download="qr-code.png">Download QR Code</a>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Manual Attendance Section -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Register Attendance Manually</h5>
                    <form id="manual-attendance-form">
                        <div class="mb-3">
                            <label for="student-id" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="student-id" name="student-id"
                                placeholder="Enter student ID" required>
                        </div>
                        <div class="mb-3">
                            <label for="course-code-manual" class="form-label">Course Code</label>
                            <input type="text" class="form-control" id="course-code-manual" name="course-code-manual"
                                placeholder="Enter course code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register Attendance</button>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('generate-qr-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const courseCode = document.getElementById('course-code').value;

        const url = '/teacher/generate-qr-code';

        fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ courseCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.qrCodeUrl) {
                    const qrCodeImage = document.getElementById('qr-code-image');
                    const expiryMessage = document.getElementById('expiry-message');
                    const downloadLink = document.getElementById('download-link');
                    const countdownTimer = document.getElementById('countdown-timer');

                    qrCodeImage.src = data.qrCodeUrl;
                    downloadLink.href = data.qrCodeUrl;

                    // Show the modal with the QR code
                    const qrModal = new bootstrap.Modal(document.getElementById('qr-modal'));
                    qrModal.show();

                    // Initialize countdown
                    let timeLeft = 30 * 60; // 30 minutes in seconds

                    const countdownInterval = setInterval(() => {
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        countdownTimer.textContent = `Expires in ${minutes}m ${seconds}s`;

                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                            qrModal.hide();
                            expiryMessage.textContent = 'The QR Code has expired. Please generate a new one.';
                        }

                        timeLeft -= 1;
                    }, 1000);

                    // Hide the modal and clear the timer after 30 minutes
                    setTimeout(() => {
                        clearInterval(countdownInterval);
                        qrModal.hide();
                    }, 1800000); // 30 minutes in milliseconds
                }
            })
            .catch(error => console.error('Error generating QR code:', error));
    });

    document.getElementById('manual-attendance-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const studentId = document.getElementById('student-id').value;
        const courseCodeManual = document.getElementById('course-code-manual').value;

        const url = '/teacher/manual-attendance-register';

        fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    studentId,
                    courseCode: courseCodeManual
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Attendance registered successfully');
                    document.getElementById('manual-attendance-form').reset();
                } else {
                    alert('Failed to register attendance');
                }
            })
            .catch(error => console.error('Error registering attendance:', error));
    });
</script>